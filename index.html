<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Adresse</title>
  </head>
  <body>

        <textarea
          placeholder="Tapez votre adresse ici !"
          id="address"
        ></textarea>
        <button class="w3-button w3-hover-black w3-khaki" onclick="getLocationWithAddress()">
          Utilisez mon addresse
        </button>
        <button class="w3-button w3-hover-black w3-blue" onclick="getLocation()">
          Magic <i class="fas fa-magic"></i>
        </button>
    <div class="valuesApiDeliver"></div>
  </body>

  <script>
    const apiKey = "dff8fa5b77e742859065b71e0d6ddc49";
    const requestOptions = {
      method: "GET",
    };
    async function getLocation() {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const reverseGeocodingUrl = `https://api.geoapify.com/v1/geocode/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&apiKey=${apiKey}`;
        const responseGeocoding = await fetch(
          reverseGeocodingUrl,
          requestOptions
        );
        const jsonGeocoding = await responseGeocoding.json();
        const { postcode } = jsonGeocoding.features[0].properties;
        testResto(pos.coords.longitude, pos.coords.latitude, postcode);
      });
    }

    async function getLocationWithAddress() {
      console.log("hello");
      const address = encodeURIComponent(
        document.querySelector("#address").value
      );
      const responseGeocoding = await fetch(
        `https://api.geoapify.com/v1/geocode/search?apiKey=${apiKey}&text=${address}`,
        requestOptions
      );
      const jsonGeocoding = await responseGeocoding.json();
      const { lon, lat, postcode } = jsonGeocoding.features[0].properties;
    }

    async function testResto(lon, lat, postcode) {
      const responseGeocoding = await fetch(
        `http://localhost:8080/eatDeliver?lat=${encodeURIComponent(
          lat
        )}&lon=${encodeURIComponent(lon)}&postCode=${postcode}`,
        requestOptions
      );
      const elment = document.querySelector(".valuesApiDeliver");
      elment.innerHTML = JSON.stringify(await responseGeocoding.json());
    }
  </script>
</html>
